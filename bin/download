#!/usr/bin/env bash

set -euo pipefail

source "$(dirname "$0")/../lib/utils.sh"

http_download() {
  local version=$1
  local path=$2
  local install_type=$3
  local file="${path}/$(tar_filename)"

  if [ "$install_type" != "version" ]; then
    echo "Install type '$install_type' not supported." >&2
    exit 1
  fi

  local url
  if [ "${ASDF_RAKU_BUILD:-}" ]; then
    url="https://rakudo.org/dl/rakudo/rakudo-$version.tar.gz"
  else
    url="$(download_url $version)" || ( echo "URL not found for version '$version'." >&2 && exit 1 )
  fi

  local tmp_file="${file}.$(date +%s)"
  local ret=1
  echo "Downloading $url to $file ..."
  if curl --version &>/dev/null; then
    curl -fsSL -o $tmp_file $url
    ret=$?
  elif wget --version &>/dev/null; then
    wget -q -O $tmp_file $url
    ret=$?
  else
    echo "'curl' or 'wget' required." >&2
    exit 1
  fi
  if [[ $ret -eq 0 ]]; then
    mv $tmp_file $file
    echo "Download complete!"
  else
    rm -f $tmp_file
    echo "Download error. Exiting." >&2
    exit 1
  fi
}

http_download "$ASDF_INSTALL_VERSION" "$ASDF_DOWNLOAD_PATH" "$ASDF_INSTALL_TYPE"
